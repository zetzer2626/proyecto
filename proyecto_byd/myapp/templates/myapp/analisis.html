{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - Análisis de Proyectos{% endblock %}

{% block page_title %}Dashboard de Proyectos{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item active">Dashboard</li>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Header del Dashboard -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="dashboard-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="h2 text-dark fw-bold mb-1">
                            <i class="fas fa-chart-line me-2 text-primary"></i>Dashboard de Proyectos
                        </h1>
                        <p class="text-muted mb-0">Análisis completo y estadísticas de tu gestión de proyectos</p>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary btn-modern" onclick="refreshDashboard()">
                            <i class="fas fa-sync-alt me-2"></i>Actualizar
                        </button>
                        <a href="{% url 'proyecto-list' %}" class="btn btn-primary btn-modern">
                            <i class="fas fa-list me-2"></i>Ver Proyectos
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tarjetas de Estadísticas Principales -->
    <div class="row g-4 mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="stat-card stat-card-primary">
                <div class="stat-card-body">
                    <div class="stat-card-icon">
                        <i class="fas fa-project-diagram"></i>
                    </div>
                    <div class="stat-card-content">
                        <h3 class="stat-card-number">{{ total_proyectos }}</h3>
                        <p class="stat-card-label">Total Proyectos</p>
                        <div class="stat-card-trend">
                            <i class="fas fa-arrow-up text-success"></i>
                            <span class="text-success">+12% este mes</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="stat-card stat-card-success">
                <div class="stat-card-body">
                    <div class="stat-card-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-card-content">
                        <h3 class="stat-card-number">{{ proyectos_completados }}</h3>
                        <p class="stat-card-label">Aprobados</p>
                        <div class="stat-card-trend">
                            <span class="text-success">{{ porcentaje_completados }}% del total</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="stat-card stat-card-warning">
                <div class="stat-card-body">
                    <div class="stat-card-icon">
                        <i class="fas fa-cogs"></i>
                    </div>
                    <div class="stat-card-content">
                        <h3 class="stat-card-number">{{ proyectos_trabajando }}</h3>
                        <p class="stat-card-label">En Desarrollo</p>
                        <div class="stat-card-trend">
                            <span class="text-warning">{{ porcentaje_trabajando }}% del total</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="stat-card stat-card-danger">
                <div class="stat-card-body">
                    <div class="stat-card-icon">
                        <i class="fas fa-times-circle"></i>
                    </div>
                    <div class="stat-card-content">
                        <h3 class="stat-card-number">{{ proyectos_no_concretados }}</h3>
                        <p class="stat-card-label">No Concretados</p>
                        <div class="stat-card-trend">
                            <span class="text-danger">{{ porcentaje_no_concretados }}% del total</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficos y Análisis -->
    <div class="row g-4 mb-4">
        <!-- Gráfico de Estados -->
        <div class="col-xl-8">
            <div class="chart-card">
                <div class="chart-card-header">
                    <h5 class="chart-card-title">
                        <i class="fas fa-chart-pie me-2 text-primary"></i>Distribución por Estado
                    </h5>
                    <div class="chart-card-actions">
                        <button class="btn btn-sm btn-outline-secondary btn-modern" onclick="toggleChartType('estados')">
                            <i class="fas fa-chart-pie"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary btn-modern" onclick="toggleChartType('estados')">
                            <i class="fas fa-chart-bar"></i>
                        </button>
                    </div>
                </div>
                <div class="chart-card-body">
                    <canvas id="estadosChart" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Gráfico de Procesos -->
        <div class="col-xl-4">
            <div class="chart-card">
                <div class="chart-card-header">
                    <h5 class="chart-card-title">
                        <i class="fas fa-chart-donut me-2 text-primary"></i>Estado de Procesos
                    </h5>
                </div>
                <div class="chart-card-body">
                    <canvas id="procesosChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráfico de Tendencias y Proyectos Recientes -->
    <div class="row g-4 mb-4">
        <!-- Gráfico de Tendencias por Año -->
        <div class="col-xl-8">
            <div class="chart-card">
                <div class="chart-card-header">
                    <h5 class="chart-card-title">
                        <i class="fas fa-chart-line me-2 text-primary"></i>Tendencias por Año
                    </h5>
                </div>
                <div class="chart-card-body">
                    <canvas id="tendenciasChart" height="250"></canvas>
                </div>
            </div>
        </div>

        <!-- Proyectos Recientes -->
        <div class="col-xl-4">
            <div class="chart-card">
                <div class="chart-card-header">
                    <h5 class="chart-card-title">
                        <i class="fas fa-clock me-2 text-primary"></i>Proyectos Recientes
                    </h5>
                    <a href="{% url 'proyecto-list' %}" class="btn btn-sm btn-outline-primary btn-modern">Ver todos</a>
                </div>
                <div class="chart-card-body">
                    <div class="recent-projects">
                        {% for proyecto in proyectos_recientes_list %}
                        <div class="recent-project-item">
                            <div class="recent-project-info">
                                <h6 class="recent-project-title">{{ proyecto.nombre }}</h6>
                                <p class="recent-project-desc">{{ proyecto.proyecto|truncatechars:50 }}</p>
                                <div class="recent-project-meta">
                                    <span class="badge bg-{% if proyecto.estado_proyecto == 'aprobado' %}success{% elif proyecto.estado_proyecto == 'trabajando' %}warning{% elif proyecto.estado_proyecto == 'no_concretado' %}danger{% else %}secondary{% endif %} badge-modern">
                                        {{ proyecto.get_estado_proyecto_display }}
                                    </span>
                                    <small class="text-muted">{{ proyecto.año }}</small>
                                </div>
                            </div>
                            <a href="{% url 'proyecto-detail' proyecto.pk %}" class="btn btn-sm btn-outline-primary btn-modern">
                                <i class="fas fa-eye"></i>
                            </a>
                        </div>
                        {% empty %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-2x mb-2 text-muted"></i>
                            <p>No hay proyectos recientes</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Estadísticas Detalladas -->
    <div class="row g-4">
        <!-- Top Años -->
        <div class="col-xl-6">
            <div class="chart-card">
                <div class="chart-card-header">
                    <h5 class="chart-card-title">
                        <i class="fas fa-calendar-alt me-2 text-primary"></i>Top 5 Años con Más Proyectos
                    </h5>
                </div>
                <div class="chart-card-body">
                    <div class="top-years">
                        {% for año in top_años %}
                        <div class="top-year-item">
                            <div class="top-year-info">
                                <h6 class="top-year-title">{{ año.año }}</h6>
                                <div class="progress progress-modern" style="height: 8px;">
                                    <div class="progress-bar bg-primary" style="width: {% widthratio año.count total_proyectos 100 %}%"></div>
                                </div>
                            </div>
                            <div class="top-year-count">
                                <span class="badge bg-primary badge-modern">{{ año.count }} proyectos</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Resumen de Estados -->
        <div class="col-xl-6">
            <div class="chart-card">
                <div class="chart-card-header">
                    <h5 class="chart-card-title">
                        <i class="fas fa-list-alt me-2 text-primary"></i>Resumen de Estados
                    </h5>
                </div>
                <div class="chart-card-body">
                    <div class="status-summary">
                        <div class="status-item">
                            <div class="status-indicator bg-success"></div>
                            <div class="status-info">
                                <span class="status-label">Aprobados</span>
                                <span class="status-count">{{ proyectos_completados }}</span>
                            </div>
                        </div>
                        <div class="status-item">
                            <div class="status-indicator bg-warning"></div>
                            <div class="status-info">
                                <span class="status-label">Trabajando</span>
                                <span class="status-count">{{ proyectos_trabajando }}</span>
                            </div>
                        </div>
                        <div class="status-item">
                            <div class="status-indicator bg-danger"></div>
                            <div class="status-info">
                                <span class="status-label">No Concretados</span>
                                <span class="status-count">{{ proyectos_no_concretados }}</span>
                            </div>
                        </div>
                        <div class="status-item">
                            <div class="status-indicator bg-info"></div>
                            <div class="status-info">
                                <span class="status-label">Observados</span>
                                <span class="status-count">{{ proyectos_observados }}</span>
                            </div>
                        </div>
                        <div class="status-item">
                            <div class="status-indicator bg-secondary"></div>
                            <div class="status-info">
                                <span class="status-label">Congelados</span>
                                <span class="status-count">{{ proyectos_congelados }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Datos de los gráficos
const chartData = {{ chart_data|safe }};

// Configuración común para los gráficos
const chartOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
        legend: {
            position: 'bottom',
            labels: {
                padding: 20,
                usePointStyle: true,
                font: {
                    size: 12
                }
            }
        }
    }
};

// Gráfico de Estados (Dona)
const estadosCtx = document.getElementById('estadosChart').getContext('2d');
let estadosChart = new Chart(estadosCtx, {
    type: 'doughnut',
    data: {
        labels: chartData.estados.labels,
        datasets: [{
            data: chartData.estados.data,
            backgroundColor: chartData.estados.colors,
            borderWidth: 2,
            borderColor: '#fff'
        }]
    },
    options: {
        ...chartOptions,
        cutout: '60%',
        plugins: {
            ...chartOptions.plugins,
            tooltip: {
                callbacks: {
                    label: function(context) {
                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                        const percentage = ((context.parsed / total) * 100).toFixed(1);
                        return `${context.label}: ${context.parsed} (${percentage}%)`;
                    }
                }
            }
        }
    }
});

// Gráfico de Procesos (Dona)
const procesosCtx = document.getElementById('procesosChart').getContext('2d');
const procesosChart = new Chart(procesosCtx, {
    type: 'doughnut',
    data: {
        labels: chartData.procesos.labels,
        datasets: [{
            data: chartData.procesos.data,
            backgroundColor: chartData.procesos.colors,
            borderWidth: 2,
            borderColor: '#fff'
        }]
    },
    options: {
        ...chartOptions,
        cutout: '60%'
    }
});

// Gráfico de Tendencias (Línea)
const tendenciasCtx = document.getElementById('tendenciasChart').getContext('2d');
const tendenciasChart = new Chart(tendenciasCtx, {
    type: 'line',
    data: {
        labels: chartData.por_año.labels,
        datasets: [{
            label: 'Proyectos por Año',
            data: chartData.por_año.data,
            borderColor: '#007bff',
            backgroundColor: 'rgba(0, 123, 255, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: '#007bff',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 6
        }]
    },
    options: {
        ...chartOptions,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        },
        plugins: {
            ...chartOptions.plugins,
            legend: {
                display: false
            }
        }
    }
});

// Función para alternar tipo de gráfico
function toggleChartType(chartName) {
    if (chartName === 'estados') {
        const newType = estadosChart.config.type === 'doughnut' ? 'bar' : 'doughnut';
        estadosChart.destroy();
        
        const newChart = new Chart(estadosCtx, {
            type: newType,
            data: {
                labels: chartData.estados.labels,
                datasets: [{
                    label: 'Proyectos',
                    data: chartData.estados.data,
                    backgroundColor: chartData.estados.colors,
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: newType === 'doughnut' ? {
                ...chartOptions,
                cutout: '60%'
            } : {
                ...chartOptions,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
        
        estadosChart = newChart;
    }
}

// Función para actualizar dashboard
function refreshDashboard() {
    location.reload();
}

// Animaciones de entrada
document.addEventListener('DOMContentLoaded', function() {
    const cards = document.querySelectorAll('.stat-card, .chart-card');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            card.style.transition = 'all 0.5s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 100);
    });
});
</script>

<style>
.dashboard-container {
    padding: 0;
}

.dashboard-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 2rem;
    border-radius: 20px;
    box-shadow: 0 8px 32px rgba(102, 126, 234, 0.15);
    margin-bottom: 2rem;
    color: white;
}

.dashboard-header h1 {
    color: white !important;
}

.dashboard-header p {
    color: rgba(255, 255, 255, 0.9) !important;
}

/* Botones modernos */
.btn-modern {
    border-radius: 12px;
    font-weight: 600;
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.btn-modern:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
}

.btn-primary.btn-modern {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-color: transparent;
}

.btn-primary.btn-modern:hover {
    background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
}

.btn-outline-primary.btn-modern {
    border-color: rgba(255, 255, 255, 0.3);
    color: white;
    background: transparent;
}

.btn-outline-primary.btn-modern:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.5);
}

.btn-outline-secondary.btn-modern {
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.2s ease;
}

.btn-outline-secondary.btn-modern:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

/* Tarjetas de Estadísticas */
.stat-card {
    background: white;
    border-radius: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
    overflow: hidden;
    border: none;
}

.stat-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
}

.stat-card-primary {
    border-left: 4px solid #667eea;
}

.stat-card-success {
    border-left: 4px solid #28a745;
}

.stat-card-warning {
    border-left: 4px solid #ffc107;
}

.stat-card-danger {
    border-left: 4px solid #dc3545;
}

.stat-card-body {
    padding: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.stat-card-icon {
    width: 60px;
    height: 60px;
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: white;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
}

.stat-card-primary .stat-card-icon {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.stat-card-success .stat-card-icon {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
}

.stat-card-warning .stat-card-icon {
    background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
}

.stat-card-danger .stat-card-icon {
    background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
}

.stat-card-content {
    flex: 1;
}

.stat-card-number {
    font-size: 2.2rem;
    font-weight: 700;
    margin: 0;
    color: #2c3e50;
    line-height: 1;
}

.stat-card-label {
    color: #6c757d;
    margin: 0.25rem 0;
    font-weight: 600;
    font-size: 0.95rem;
}

.stat-card-trend {
    font-size: 0.875rem;
    font-weight: 500;
    margin-top: 0.25rem;
}

/* Tarjetas de Gráficos */
.chart-card {
    background: white;
    border-radius: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    overflow: hidden;
    border: none;
    transition: all 0.3s ease;
}

.chart-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
}

.chart-card-header {
    padding: 1.5rem;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
}

.chart-card-title {
    margin: 0;
    font-weight: 600;
    color: #2c3e50;
    font-size: 1.1rem;
}

.chart-card-actions {
    display: flex;
    gap: 0.5rem;
}

.chart-card-body {
    padding: 1.5rem;
    position: relative;
}

/* Proyectos Recientes */
.recent-projects {
    max-height: 400px;
    overflow-y: auto;
}

.recent-project-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 0;
    border-bottom: 1px solid #f1f3f4;
    transition: all 0.2s ease;
}

.recent-project-item:hover {
    background: rgba(102, 126, 234, 0.05);
    border-radius: 8px;
    padding-left: 0.5rem;
    padding-right: 0.5rem;
}

.recent-project-item:last-child {
    border-bottom: none;
}

.recent-project-info {
    flex: 1;
}

.recent-project-title {
    font-weight: 600;
    margin: 0 0 0.25rem 0;
    color: #2c3e50;
    font-size: 0.95rem;
}

.recent-project-desc {
    color: #6c757d;
    margin: 0 0 0.5rem 0;
    font-size: 0.875rem;
}

.recent-project-meta {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

/* Top Años */
.top-years {
    max-height: 300px;
    overflow-y: auto;
}

.top-year-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 0;
    border-bottom: 1px solid #f1f3f4;
    transition: all 0.2s ease;
}

.top-year-item:hover {
    background: rgba(102, 126, 234, 0.05);
    border-radius: 8px;
    padding-left: 0.5rem;
    padding-right: 0.5rem;
}

.top-year-item:last-child {
    border-bottom: none;
}

.top-year-info {
    flex: 1;
    margin-right: 1rem;
}

.top-year-title {
    font-weight: 600;
    margin: 0 0 0.5rem 0;
    color: #2c3e50;
    font-size: 0.95rem;
}

.top-year-count {
    min-width: 100px;
    text-align: right;
}

/* Progress bar moderno */
.progress-modern {
    background-color: #e9ecef;
    border-radius: 10px;
    overflow: hidden;
}

.progress-modern .progress-bar {
    border-radius: 10px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

/* Badges modernos */
.badge-modern {
    border-radius: 8px;
    font-weight: 500;
    padding: 0.5rem 0.75rem;
    font-size: 0.75rem;
}

/* Resumen de Estados */
.status-summary {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.status-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    border-radius: 12px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    transition: all 0.2s ease;
}

.status-item:hover {
    transform: translateX(4px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.status-info {
    flex: 1;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.status-label {
    font-weight: 600;
    color: #2c3e50;
    font-size: 0.9rem;
}

.status-count {
    font-weight: 700;
    color: #667eea;
    font-size: 1.1rem;
}

/* Responsive */
@media (max-width: 768px) {
    .dashboard-header {
        padding: 1.5rem;
    }
    
    .stat-card-body {
        padding: 1rem;
    }
    
    .stat-card-number {
        font-size: 1.8rem;
    }
    
    .chart-card-header {
        padding: 1rem;
        flex-direction: column;
        gap: 1rem;
        align-items: flex-start;
    }
    
    .chart-card-body {
        padding: 1rem;
    }
    
    .dashboard-header .d-flex {
        flex-direction: column;
        gap: 1rem;
        align-items: flex-start !important;
    }
}

/* Scrollbar personalizado */
.recent-projects::-webkit-scrollbar,
.top-years::-webkit-scrollbar {
    width: 6px;
}

.recent-projects::-webkit-scrollbar-track,
.top-years::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.recent-projects::-webkit-scrollbar-thumb,
.top-years::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 3px;
}

.recent-projects::-webkit-scrollbar-thumb:hover,
.top-years::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
}
</style>

{% endblock %}
