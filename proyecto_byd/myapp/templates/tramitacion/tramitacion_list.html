{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Gestión de Tramitaciones{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h2 text-dark fw-bold mb-1">Gestión de Tramitaciones</h1>
                    <p class="text-muted mb-0">Administra y supervisa todas las tramitaciones del sistema</p>
                </div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-primary d-flex align-items-center gap-2" data-bs-toggle="modal" data-bs-target="#createModal">
                        <i class="fas fa-plus"></i>
                        <span>Nueva Tramitación</span>
                    </button>

                    <a href="{% url 'exportar_tramitacion_excel' %}" class="btn btn-outline-success d-flex align-items-center gap-2">
                        <i class="fas fa-file-excel"></i>
                        <span>Exportar</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row g-3 mb-4">
        <!-- Completados -->
        <div class="col-6 col-md-6">
            <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%);">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-white bg-opacity-25 rounded-circle p-3">
                                <i class="fa-solid fa-check-circle text-white fa-lg"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="text-white mb-1 fw-semibold">Completados</h6>
                            <h3 class="text-white mb-0 fw-bold">{{ completados_count }}</h3>
                            <small class="text-white">Tramitaciones</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sin Fecha -->
        <div class="col-6 col-md-6">
            <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-white bg-opacity-25 rounded-circle p-3">
                                <i class="fa-solid fa-exclamation-circle text-white fa-lg"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="text-white mb-1 fw-semibold">Sin Fecha</h6>
                            <h3 class="text-white mb-0 fw-bold">{{ sin_fecha_count }}</h3>
                            <small class="text-white">Sin recepción</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filters Section -->
    <div class="filters-container mb-4">
        <div class="filters-card">
            <div class="filters-header">
                <div class="filters-title">
                    <button id="btnToggleFilters" class="btn btn-link text-white p-0 me-2" style="border: none; background: none;">
                        <i class="fas fa-chevron-down" id="iconToggleFilters"></i>
                    </button>
                    <div class="title-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <div class="title-content">
                        <h4 class="title-text">Filtros de Búsqueda</h4>
                        <p class="title-subtitle">Refina tus resultados con filtros avanzados</p>
                    </div>
                </div>
                <div class="filters-actions">
                    <div class="active-filters">
                        <span class="filter-count">2</span>
                        <span class="filter-status-label">filtros activos</span>
                    </div>
                </div>
            </div>
            
            <div class="filters-body" id="filtersBody" style="display: none;">
                <form method="get" class="filters-form" action="{% url 'tramitacion-list' %}">
                    <div class="filters-grid">
                        <!-- Campo de búsqueda principal -->
                        <div class="filter-item search-filter">
                            <div class="filter-input-wrapper">
                                <div class="input-icon">
                                    <i class="fas fa-search"></i>
                                </div>
                                <input 
                                    type="text" 
                                    id="search" 
                                    name="q" 
                                    class="filter-input search-input" 
                                    placeholder="Buscar presupuesto, nombre, dirección..." 
                                    value="{{ request.GET.q }}">
                                <div class="input-focus-border"></div>
                            </div>
                        </div>

                        <!-- Filtro por año -->
                        <div class="filter-item">
                            <label class="filter-label">Año</label>
                            <div class="filter-input-wrapper">
                                <div class="input-icon">
                                    <i class="fas fa-calendar-alt"></i>
                                </div>
                                <input 
                                    type="number" 
                                    id="año" 
                                    name="año" 
                                    class="filter-input" 
                                    placeholder="Ej: 2024" 
                                    value="{{ request.GET.año }}">
                                <div class="input-focus-border"></div>
                            </div>
                        </div>

                        <!-- Filtro por estado -->
                        <div class="filter-item">
                            <label class="filter-label">Estado</label>
                            <div class="filter-input-wrapper">
                                <div class="input-icon">
                                    <i class="fas fa-flag"></i>
                                </div>
                                <select id="estado" name="estado" class="filter-input">
                                    <option value="">Todos los Estados</option>
                                    <option value="completado" {% if request.GET.estado == 'completado' %}selected{% endif %}>Completado</option>
                                    <option value="pendiente" {% if request.GET.estado == 'pendiente' %}selected{% endif %}>Pendiente</option>
                                </select>
                                <div class="input-focus-border"></div>
                            </div>
                        </div>

                        <!-- Filtro por fecha desde -->
                        <div class="filter-item">
                            <label class="filter-label">Fecha Desde</label>
                            <div class="filter-input-wrapper">
                                <div class="input-icon">
                                    <i class="fas fa-calendar"></i>
                                </div>
                                <input 
                                    type="date" 
                                    id="fecha_desde" 
                                    name="fecha_desde" 
                                    class="filter-input" 
                                    value="{{ request.GET.fecha_desde }}">
                                <div class="input-focus-border"></div>
                            </div>
                        </div>

                        <!-- Botones de acción -->
                        <div class="filter-item actions-filter">
                            <div class="filter-actions">
                                <button type="submit" class="btn-primary">
                                    <i class="fas fa-search"></i>
                                    <span>Buscar</span>
                                </button>
                                <a href="{% url 'tramitacion-list' %}" class="btn-secondary">
                                    <i class="fas fa-undo"></i>
                                    <span>Limpiar</span>
                                </a>
                                <button type="button" class="btn-advanced" data-bs-toggle="modal" data-bs-target="#advancedFiltersModal">
                                    <i class="fas fa-filter"></i>
                                    <span>Filtros Avanzados</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Tramitaciones Table Section -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-0 py-3">
            <h5 class="mb-0 text-dark fw-semibold">
                <i class="fas fa-table me-2 text-primary"></i>
                Lista de Tramitaciones
            </h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table id="example" class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="border-0 fw-semibold text-dark" style="min-width: 80px;">Presup</th>
                            <th class="border-0 fw-semibold text-dark" style="min-width: 60px;">Año</th>
                            <th class="border-0 fw-semibold text-dark" style="min-width: 120px;">Nombre</th>
                            <th class="border-0 fw-semibold text-dark" style="min-width: 120px;">Dirección</th>
                            <th class="border-0 fw-semibold text-dark" style="min-width: 150px;">Nota</th>
                            <th class="border-0 fw-semibold text-dark" style="min-width: 110px;">F. Entrega</th>
                            <th class="border-0 fw-semibold text-dark" style="min-width: 90px;">Drive</th>
                            <th class="border-0 fw-semibold text-dark" style="min-width: 100px;">Estado</th>
                            <th class="border-0 fw-semibold text-dark" style="min-width: 100px;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for tramitacion in tramitaciones %}
                        <tr class="border-bottom">
                            <td>
                                <span class="badge rounded-pill" style="background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);">
                                    {{ tramitacion.presupuesto }}
                                </span>
                            </td>
                            <td class="text-center">
                                <span class="fw-bold text-dark">{{ tramitacion.año }}</span>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="avatar me-3">
                                        <div class="avatar-initial rounded-circle" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                            <span class="text-white fw-bold">{{ tramitacion.nombre|first|upper }}</span>
                                        </div>
                                    </div>
                                    <div>
                                        <span class="fw-bold text-dark">{{ tramitacion.nombre }}</span>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="text-dark">{{ tramitacion.direccion }}</span>
                            </td>
                            <td>
                                <div class="text-wrap" style="max-width: 150px;">
                                    <span class="text-dark">{{ tramitacion.nota }}</span>
                                </div>
                            </td>
                            <td class="text-center">
                                {% if tramitacion.fecha_recepcion %}
                                    <span class="badge rounded-pill" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%);">
                                        {{ tramitacion.fecha_recepcion }}
                                    </span>
                                {% else %}
                                    <span class="text-muted">Sin Fecha</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if tramitacion.link_tramitacion %}
                                    <a href="{{ tramitacion.link_tramitacion }}" target="_blank" class="btn btn-sm btn-outline-warning rounded-pill" title="Ver en Drive" style="border-color: #ffc107; color: #856404;">
                                        <i class="fab fa-google-drive" style="color: #ffc107;"></i>
                                    </a>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if tramitacion.fecha_recepcion %}
                                    <span class="badge rounded-pill" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                                        Completado
                                    </span>
                                {% else %}
                                    <span class="badge rounded-pill" style="background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);">
                                        Pendiente
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="d-flex gap-1 justify-content-center">
                                    <button type="button" class="btn btn-sm btn-outline-info rounded-pill detail-btn" title="Ver Detalles" 
                                            data-id="{{ tramitacion.pk }}"
                                            data-presupuesto="{{ tramitacion.presupuesto }}"
                                            data-año="{{ tramitacion.año }}"
                                            data-nombre="{{ tramitacion.nombre }}"
                                            data-direccion="{{ tramitacion.direccion }}"
                                            data-fecha="{{ tramitacion.fecha_recepcion|default:'' }}"
                                            data-nota="{{ tramitacion.nota|default:'' }}"
                                            data-descripcion="{{ tramitacion.descripcion|default:'' }}"

                                            data-enlace="{{ tramitacion.link_tramitacion|default:'' }}"
                                            data-estado="{% if tramitacion.fecha_recepcion %}Completado{% else %}Pendiente{% endif %}">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-warning rounded-pill edit-btn" title="Editar Tramitación" 
                                            data-id="{{ tramitacion.pk }}"
                                            data-presupuesto="{{ tramitacion.presupuesto }}"
                                            data-año="{{ tramitacion.año }}"
                                            data-nombre="{{ tramitacion.nombre }}"
                                            data-direccion="{{ tramitacion.direccion }}"
                                            data-fecha="{{ tramitacion.fecha_recepcion|default:'' }}"
                                            data-nota="{{ tramitacion.nota|default:'' }}"
                                            data-descripcion="{{ tramitacion.descripcion|default:'' }}"
                                            data-enlace="{{ tramitacion.link_tramitacion|default:'' }}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-danger rounded-pill delete-btn" title="Eliminar Tramitación" 
                                            data-id="{{ tramitacion.pk }}"
                                            data-presupuesto="{{ tramitacion.presupuesto }}"
                                            data-nombre="{{ tramitacion.nombre }}"
                                            data-direccion="{{ tramitacion.direccion }}"
                                            data-año="{{ tramitacion.año }}">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="9" class="text-center py-5">
                                <div class="text-muted">
                                    <i class="fas fa-tasks fa-3x mb-3 opacity-50"></i>
                                    <h5 class="fw-semibold">No se encontraron tramitaciones</h5>
                                    <p class="mb-0">No hay tramitaciones que coincidan con los criterios de búsqueda.</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modales -->
<!-- Modal de Confirmación de Eliminación -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-danger text-white border-0">
                <div class="d-flex align-items-center">
                    <div class="modal-icon me-3">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div>
                        <h5 class="modal-title mb-0" id="deleteModalLabel">Confirmar Eliminación</h5>
                        <small class="opacity-75">Esta acción no se puede deshacer</small>
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="alert alert-warning mb-3">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span>¿Estás seguro de que deseas eliminar esta tramitación?</span>
                    </div>
                </div>
                <div class="tramitacion-info">
                    <h6 class="text-dark fw-semibold mb-3">
                        <i class="fas fa-info-circle text-primary me-2"></i>
                        Información de la Tramitación
                    </h6>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Presupuesto:</span>
                            <span class="info-value" id="deletePresupuesto"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Nombre:</span>
                            <span class="info-value" id="deleteNombre"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Dirección:</span>
                            <span class="info-value" id="deleteDireccion"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Año:</span>
                            <span class="info-value" id="deleteAño"></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>
                    Cancelar
                </button>
                <form id="deleteForm" method="POST" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash-alt me-2"></i>
                        Confirmar Eliminación
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Detalles Completos -->
<div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-info text-white border-0">
                <div class="d-flex align-items-center">
                    <div class="modal-icon me-3">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <div>
                        <h5 class="modal-title mb-0" id="detailModalLabel">Detalles Completos de Tramitación</h5>
                        <small class="opacity-75">Información completa del trámite</small>
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row">
                    <!-- Información Principal -->
                    <div class="col-lg-8">
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-header bg-white border-0 py-3">
                                <h6 class="text-primary fw-semibold mb-0">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Información General
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="info-item">
                                            <div class="info-label">
                                                <i class="fas fa-hashtag text-primary me-2"></i>
                                                Presupuesto
                                            </div>
                                            <div class="info-value" id="detailPresupuesto"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="info-item">
                                            <div class="info-label">
                                                <i class="fas fa-calendar text-primary me-2"></i>
                                                Año
                                            </div>
                                            <div class="info-value" id="detailAño"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="info-item">
                                            <div class="info-label">
                                                <i class="fas fa-user text-primary me-2"></i>
                                                Nombre
                                            </div>
                                            <div class="info-value" id="detailNombre"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="info-item">
                                            <div class="info-label">
                                                <i class="fas fa-map-marker-alt text-primary me-2"></i>
                                                Dirección
                                            </div>
                                            <div class="info-value" id="detailDireccion"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="info-item">
                                            <div class="info-label">
                                                <i class="fas fa-calendar-check text-primary me-2"></i>
                                                Fecha de Entrega
                                            </div>
                                            <div class="info-value" id="detailFecha"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="info-item">
                                            <div class="info-label">
                                                <i class="fas fa-flag text-primary me-2"></i>
                                                Estado
                                            </div>
                                            <div class="info-value" id="detailEstado"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Descripción y Notas -->
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-white border-0 py-3">
                                <h6 class="text-primary fw-semibold mb-0">
                                    <i class="fas fa-align-left me-2"></i>
                                    Descripción y Notas
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-12">
                                        <div class="info-item">
                                            <div class="info-label">
                                                <i class="fas fa-align-left text-primary me-2"></i>
                                                Descripción
                                            </div>
                                            <div class="content-box" id="detailDescripcion"></div>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="info-item">
                                            <div class="info-label">
                                                <i class="fas fa-sticky-note text-primary me-2"></i>
                                                Nota
                                            </div>
                                            <div class="content-box" id="detailNota"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sidebar -->
                    <div class="col-lg-4">
                        <!-- Documentos -->
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-header bg-white border-0 py-3">
                                <h6 class="text-primary fw-semibold mb-0">
                                    <i class="fas fa-paperclip me-2"></i>
                                    Documentos
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="d-flex flex-column gap-3">
                                    <div class="document-item">
                                        <div class="document-icon">
                                            <i class="fas fa-file-alt"></i>
                                        </div>
                                        <div class="document-content">
                                            <h6 class="document-title">Documento de Tramitación</h6>
                                            <div id="detailDocumento">
                                                <!-- Contenido dinámico -->
                                            </div>
                                        </div>
                                    </div>
                                    <div class="document-item">
                                        <div class="document-icon">
                                            <i class="fas fa-link"></i>
                                        </div>
                                        <div class="document-content">
                                            <h6 class="document-title">Enlace de Tramitación</h6>
                                            <div id="detailEnlace">
                                                <!-- Contenido dinámico -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Acciones Rápidas -->
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-white border-0 py-3">
                                <h6 class="text-primary fw-semibold mb-0">
                                    <i class="fas fa-cogs me-2"></i>
                                    Acciones Rápidas
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="d-flex flex-column gap-2">
                                    <button type="button" class="btn btn-warning" id="detailEditBtn">
                                        <i class="fas fa-edit me-2"></i>
                                        Editar Tramitación
                                    </button>
                                    <button type="button" class="btn btn-danger" id="detailDeleteBtn">
                                        <i class="fas fa-trash-alt me-2"></i>
                                        Eliminar Tramitación
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>
                    Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Edición -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-warning text-white border-0">
                <div class="d-flex align-items-center">
                    <div class="modal-icon me-3">
                        <i class="fas fa-edit"></i>
                    </div>
                    <div>
                        <h5 class="modal-title mb-0" id="editModalLabel">Editar Tramitación</h5>
                        <small class="opacity-75">Modificar información del trámite</small>
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <form id="editForm" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="row g-4">
                        <!-- Información Básica -->
                        <div class="col-12">
                            <div class="form-section">
                                <div class="section-header">
                                    <h6 class="text-primary fw-semibold mb-0">
                                        <i class="fas fa-info-circle me-2"></i>
                                        Información Básica
                                    </h6>
                                </div>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label fw-semibold">
                                                <i class="fas fa-hashtag me-1 text-primary"></i>
                                                Presupuesto
                                            </label>
                                            <input type="text" class="form-control" name="presupuesto" id="editPresupuesto" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label fw-semibold">
                                                <i class="fas fa-calendar me-1 text-primary"></i>
                                                Año
                                            </label>
                                            <input type="number" class="form-control" name="año" id="editAño" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label fw-semibold">
                                                <i class="fas fa-user me-1 text-primary"></i>
                                                Nombre
                                            </label>
                                            <input type="text" class="form-control" name="nombre" id="editNombre" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label fw-semibold">
                                                <i class="fas fa-map-marker-alt me-1 text-primary"></i>
                                                Dirección
                                            </label>
                                            <input type="text" class="form-control" name="direccion" id="editDireccion" required>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Fechas y Descripción -->
                        <div class="col-12">
                            <div class="form-section">
                                <div class="section-header">
                                    <h6 class="text-primary fw-semibold mb-0">
                                        <i class="fas fa-clock me-2"></i>
                                        Fechas y Descripción
                                    </h6>
                                </div>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label fw-semibold">
                                                <i class="fas fa-calendar-check me-1 text-primary"></i>
                                                Fecha de Entrega
                                            </label>
                                            <input type="text" class="form-control" name="fecha_recepcion" id="editFecha" placeholder="DD/MM/YYYY">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label fw-semibold">
                                                <i class="fas fa-align-left me-1 text-primary"></i>
                                                Descripción
                                            </label>
                                            <textarea class="form-control" name="descripcion" id="editDescripcion" rows="3"></textarea>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="form-group">
                                            <label class="form-label fw-semibold">
                                                <i class="fas fa-sticky-note me-1 text-primary"></i>
                                                Nota
                                            </label>
                                            <textarea class="form-control" name="nota" id="editNota" rows="3"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Enlaces -->
                        <div class="col-12">
                            <div class="form-section">
                                <div class="section-header">
                                    <h6 class="text-primary fw-semibold mb-0">
                                        <i class="fas fa-link me-2"></i>
                                        Enlaces
                                    </h6>
                                </div>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label fw-semibold">
                                                <i class="fas fa-link me-1 text-primary"></i>
                                                Enlace de Tramitación
                                            </label>
                                            <input type="url" class="form-control" name="link_tramitacion" id="editEnlace">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0 bg-light">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>
                    Cancelar
                </button>
                <button type="submit" form="editForm" class="btn btn-warning">
                    <i class="fas fa-save me-2"></i>
                    Guardar Cambios
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Filtros Avanzados -->
<div class="modal fade" id="advancedFiltersModal" tabindex="-1" aria-labelledby="advancedFiltersModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-success text-white border-0">
                <div class="d-flex align-items-center">
                    <div class="modal-icon me-3">
                        <i class="fas fa-filter"></i>
                    </div>
                    <div>
                        <h5 class="modal-title mb-0" id="advancedFiltersModalLabel">Filtros Avanzados</h5>
                        <small class="opacity-75">Configuración detallada de búsqueda</small>
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <form id="advancedFiltersForm" method="get" action="{% url 'tramitacion-list' %}">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-search me-1 text-primary"></i>
                                Búsqueda General
                            </label>
                            <input type="text" class="form-control" name="q" placeholder="Buscar en todos los campos..." value="{{ request.GET.q }}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-calendar me-1 text-primary"></i>
                                Año
                            </label>
                            <input type="number" class="form-control" name="año" placeholder="Ej: 2024" value="{{ request.GET.año }}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-flag me-1 text-primary"></i>
                                Estado
                            </label>
                            <select class="form-select" name="estado">
                                <option value="">Todos los Estados</option>
                                <option value="completado" {% if request.GET.estado == 'completado' %}selected{% endif %}>Completado</option>
                                <option value="pendiente" {% if request.GET.estado == 'pendiente' %}selected{% endif %}>Pendiente</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-calendar-alt me-1 text-primary"></i>
                                Fecha Desde
                            </label>
                            <input type="date" class="form-control" name="fecha_desde" value="{{ request.GET.fecha_desde }}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-calendar-alt me-1 text-primary"></i>
                                Fecha Hasta
                            </label>
                            <input type="date" class="form-control" name="fecha_hasta" value="{{ request.GET.fecha_hasta }}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-sort me-1 text-primary"></i>
                                Ordenar Por
                            </label>
                            <select class="form-select" name="orden">
                                <option value="fecha_desc" {% if request.GET.orden == 'fecha_desc' %}selected{% endif %}>Fecha (Más reciente)</option>
                                <option value="fecha_asc" {% if request.GET.orden == 'fecha_asc' %}selected{% endif %}>Fecha (Más antigua)</option>
                                <option value="nombre_asc" {% if request.GET.orden == 'nombre_asc' %}selected{% endif %}>Nombre (A-Z)</option>
                                <option value="nombre_desc" {% if request.GET.orden == 'nombre_desc' %}selected{% endif %}>Nombre (Z-A)</option>
                                <option value="presupuesto_asc" {% if request.GET.orden == 'presupuesto_asc' %}selected{% endif %}>Presupuesto (Menor)</option>
                                <option value="presupuesto_desc" {% if request.GET.orden == 'presupuesto_desc' %}selected{% endif %}>Presupuesto (Mayor)</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0 bg-light">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>
                    Cancelar
                </button>
                <button type="button" class="btn btn-outline-warning" id="clearFiltersBtn">
                    <i class="fas fa-undo me-2"></i>
                    Limpiar Filtros
                </button>
                <button type="submit" form="advancedFiltersForm" class="btn btn-success">
                    <i class="fas fa-search me-2"></i>
                    Aplicar Filtros
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Creación -->
<div class="modal fade" id="createModal" tabindex="-1" aria-labelledby="createModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-success text-white border-0">
                <div class="d-flex align-items-center">
                    <div class="modal-icon me-3">
                        <i class="fas fa-plus"></i>
                    </div>
                    <div>
                        <h5 class="modal-title mb-0" id="createModalLabel">Crear Nueva Tramitación</h5>
                        <small class="opacity-75">Agregar nueva tramitación al sistema</small>
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <form id="createForm" method="post" enctype="multipart/form-data" action="{% url 'tramitacion-create' %}">
                    {% csrf_token %}
                    <div class="row g-4">
                        <!-- Información Básica -->
                        <div class="col-12">
                            <div class="form-section">
                                <div class="section-header">
                                    <h6 class="text-primary fw-semibold mb-0">
                                        <i class="fas fa-info-circle me-2"></i>
                                        Información Básica
                                    </h6>
                                    <small class="text-muted">Datos principales de la tramitación</small>
                                </div>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label fw-semibold">
                                                <i class="fas fa-hashtag me-1 text-primary"></i>
                                                Presupuesto <span class="text-danger">*</span>
                                            </label>
                                            <input type="text" class="form-control" name="presupuesto" placeholder="Ej: 001-2024" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label fw-semibold">
                                                <i class="fas fa-calendar me-1 text-primary"></i>
                                                Año <span class="text-danger">*</span>
                                            </label>
                                            <input type="number" class="form-control" name="año" placeholder="2024" min="2020" max="2030" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label fw-semibold">
                                                <i class="fas fa-user me-1 text-primary"></i>
                                                Nombre <span class="text-danger">*</span>
                                            </label>
                                            <input type="text" class="form-control" name="nombre" placeholder="Nombre completo del cliente" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label fw-semibold">
                                                <i class="fas fa-map-marker-alt me-1 text-primary"></i>
                                                Dirección <span class="text-danger">*</span>
                                            </label>
                                            <input type="text" class="form-control" name="direccion" placeholder="Dirección completa del proyecto" required>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Fechas y Descripción -->
                        <div class="col-12">
                            <div class="form-section">
                                <div class="section-header">
                                    <h6 class="text-primary fw-semibold mb-0">
                                        <i class="fas fa-clock me-2"></i>
                                        Fechas y Descripción
                                    </h6>
                                    <small class="text-muted">Información temporal y descriptiva</small>
                                </div>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label fw-semibold">
                                                <i class="fas fa-calendar-check me-1 text-primary"></i>
                                                Fecha de Entrega
                                            </label>
                                            <input type="text" class="form-control" name="fecha_recepcion" placeholder="DD/MM/YYYY">
                                            <small class="text-muted">Fecha estimada de entrega del trámite</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label fw-semibold">
                                                <i class="fas fa-link me-1 text-primary"></i>
                                                Enlace de Tramitación
                                            </label>
                                            <input type="url" class="form-control" name="link_tramitacion" placeholder="https://ejemplo.com">
                                            <small class="text-muted">Enlace externo relacionado con el trámite</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label fw-semibold">
                                                <i class="fas fa-align-left me-1 text-primary"></i>
                                                Descripción
                                            </label>
                                            <textarea class="form-control" name="descripcion" rows="3" placeholder="Descripción detallada del trámite..."></textarea>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label fw-semibold">
                                                <i class="fas fa-sticky-note me-1 text-primary"></i>
                                                Nota
                                            </label>
                                            <textarea class="form-control" name="nota" rows="3" placeholder="Notas adicionales o comentarios..."></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Botones del formulario -->
                    <div class="d-flex justify-content-end gap-2 mt-4">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-2"></i>
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-success" id="createSubmitBtn">
                            <i class="fas fa-save me-2"></i>
                            Crear Tramitación
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    /* Professional Design Improvements */
    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
    }
    
    /* FontAwesome Icon Styles */
    .fa-solid, .fas, .fa {
        font-family: "Font Awesome 6 Free";
        font-weight: 900;
        display: inline-block;
        font-style: normal;
        font-variant: normal;
        text-rendering: auto;
        line-height: 1;
    }
    
    .fa-lg {
        font-size: 1.33333em;
        line-height: 0.75em;
        vertical-align: -0.0667em;
    }
    
    /* Card Icon Styles */
    .card .bg-white.bg-opacity-25 {
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .card .bg-white.bg-opacity-25:hover {
        transform: scale(1.1);
        background: rgba(255, 255, 255, 0.4) !important;
        box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }
    
    .card .bg-white.bg-opacity-25 i {
        font-size: 1.5rem;
        color: white !important;
        text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
    }
    
    /* Card Enhancements */
    .card {
        border-radius: 12px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .card:hover {
        transform: translateY(-3px);
        box-shadow: 0 12px 30px rgba(0,0,0,0.15) !important;
    }
    
    /* Statistics Cards Specific Styles */
    .row.g-3 .card {
        border: none;
        overflow: hidden;
        position: relative;
    }
    
    .row.g-3 .card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
        pointer-events: none;
    }
    
    .row.g-3 .card .card-body {
        position: relative;
        z-index: 1;
    }
    
    /* Table Improvements */
    .table {
        font-size: 0.875rem;
        border-collapse: separate;
        border-spacing: 0;
    }
    
    .table thead th {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: none;
        padding: 1rem 0.75rem;
        font-weight: 600;
        color: #495057;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .table tbody tr {
        transition: all 0.2s ease;
    }
    
    .table tbody tr:hover {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        transform: scale(1.001);
    }
    
    .table td {
        padding: 1rem 0.75rem;
        vertical-align: middle;
        border: none;
        border-bottom: 1px solid #f1f3f4;
    }
    
    /* Badge Improvements */
    .badge {
        font-weight: 500;
        padding: 0.5em 0.75em;
        font-size: 0.75rem;
    }
    
    /* Button Improvements */
    .btn {
        font-weight: 500;
        border-radius: 8px;
        transition: all 0.3s ease;
        border: none;
    }
    
    .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .btn-outline-primary {
        border: 2px solid #007bff;
        color: #007bff;
    }
    
    .btn-outline-primary:hover {
        background: #007bff;
        border-color: #007bff;
    }
    
    .btn-outline-warning {
        border: 2px solid #ffc107;
        color: #ffc107;
    }
    
    .btn-outline-warning:hover {
        background: #ffc107;
        border-color: #ffc107;
        color: #000;
    }
    
    .btn-outline-danger {
        border: 2px solid #dc3545;
        color: #dc3545;
    }
    
    .btn-outline-danger:hover {
        background: #dc3545;
        border-color: #dc3545;
    }
    
    .btn-outline-success {
        border: 2px solid #28a745;
        color: #28a745;
    }
    
    .btn-outline-success:hover {
        background: #28a745;
        border-color: #28a745;
    }
    
    /* Avatar Styles */
    .avatar {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .avatar-initial {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        font-weight: 600;
    }
    
    /* Estilos elegantes para la sección de filtros */
    .filters-container {
        margin-bottom: 2rem;
    }
    
    .filters-card {
        background: linear-gradient(135deg, #ffffff 0%, #fafbfc 100%);
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.04), 0 1px 3px rgba(0, 0, 0, 0.02);
        border: 1px solid rgba(226, 232, 240, 0.6);
        overflow: hidden;
        position: relative;
        backdrop-filter: blur(10px);
    }
    
    .filters-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        opacity: 0.8;
    }
    
    .filters-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 1.5rem 2rem;
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
        overflow: hidden;
    }
    
    .filters-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
        pointer-events: none;
    }
    
    .filters-title {
        display: flex;
        align-items: center;
        gap: 1rem;
        position: relative;
        z-index: 1;
    }
    
    .title-icon {
        width: 48px;
        height: 48px;
        background: rgba(255, 255, 255, 0.15);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .title-icon i {
        font-size: 1.25rem;
        color: white;
        opacity: 0.95;
    }
    
    .title-content {
        flex: 1;
    }
    
    .title-text {
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0;
        letter-spacing: -0.3px;
    }
    
    .title-subtitle {
        font-size: 0.85rem;
        opacity: 0.85;
        margin: 0.2rem 0 0 0;
        font-weight: 400;
        letter-spacing: 0.2px;
    }
    
    .filters-actions {
        position: relative;
        z-index: 1;
    }
    
    .active-filters {
        background: rgba(255, 255, 255, 0.12);
        border-radius: 10px;
        padding: 0.6rem 1rem;
        backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.18);
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }
    
    .filter-count {
        background: rgba(255, 255, 255, 0.9);
        color: #667eea;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .filter-status-label {
        font-size: 0.85rem;
        font-weight: 500;
        color: white;
    }
    
    .filters-body {
        padding: 1.75rem 2rem;
    }
    
    .filters-grid {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 1fr 1.5fr;
        gap: 1.25rem;
        align-items: end;
    }
    
    .filter-item {
        position: relative;
    }
    
    .filter-label {
        font-size: 0.75rem;
        font-weight: 500;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.4px;
        margin-bottom: 0.4rem;
        display: block;
    }
    
    .filter-input-wrapper {
        position: relative;
        background: #ffffff;
        border-radius: 10px;
        border: 1.5px solid #e2e8f0;
        transition: all 0.25s ease;
        overflow: hidden;
    }
    
    .filter-input-wrapper:hover {
        border-color: #cbd5e1;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
        transform: translateY(-1px);
    }
    
    .filter-input-wrapper:focus-within {
        border-color: #667eea;
        box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.08);
        transform: translateY(-1px);
    }
    
    .input-icon {
        position: absolute;
        left: 0.875rem;
        top: 50%;
        transform: translateY(-50%);
        color: #94a3b8;
        z-index: 2;
        transition: color 0.25s ease;
        font-size: 0.9rem;
    }
    
    .filter-input-wrapper:focus-within .input-icon {
        color: #667eea;
    }
    
    .filter-input {
        width: 100%;
        padding: 0.875rem 1rem 0.875rem 2.75rem;
        border: none;
        background: transparent;
        font-size: 0.9rem;
        color: #1e293b;
        outline: none;
        transition: all 0.25s ease;
    }
    
    .filter-input::placeholder {
        color: #94a3b8;
        font-weight: 400;
    }
    
    .search-filter .filter-input-wrapper {
        background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
        border-color: #e2e8f0;
    }
    
    .search-filter .filter-input-wrapper:focus-within {
        background: #ffffff;
        border-color: #667eea;
    }
    
    .input-focus-border {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 0;
        height: 2px;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        transition: width 0.25s ease;
    }
    
    .filter-input-wrapper:focus-within .input-focus-border {
        width: 100%;
    }
    
    .filter-actions {
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
    }
    
    .btn-primary, .btn-secondary {
        padding: 0.875rem 1.25rem;
        border: none;
        border-radius: 10px;
        font-weight: 500;
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.4rem;
        transition: all 0.25s ease;
        text-decoration: none;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
    }
    
    .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        color: white;
    }
    
    .btn-secondary {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        color: #64748b;
        border: 1.5px solid #e2e8f0;
    }
    
    .btn-secondary:hover {
        transform: translateY(-1px);
        box-shadow: 0 3px 12px rgba(0, 0, 0, 0.08);
        color: #475569;
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    }
    
    .btn-advanced {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);
    }
    
    .btn-advanced:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        background: linear-gradient(135deg, #059669 0%, #047857 100%);
        color: white;
    }
    
    /* Responsive para filtros elegantes */
    @media (max-width: 1200px) {
        .filters-grid {
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .search-filter {
            grid-column: 1 / -1;
        }
        
        .actions-filter {
            grid-column: 1 / -1;
        }
        
        .filter-actions {
            flex-direction: row;
            justify-content: center;
        }
    }
    
    @media (max-width: 768px) {
        .filters-header {
            padding: 1.5rem;
            flex-direction: column;
            gap: 1rem;
            text-align: center;
        }
        
        .filters-title {
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .title-icon {
            width: 50px;
            height: 50px;
        }
        
        .title-text {
            font-size: 1.25rem;
        }
        
        .filters-body {
            padding: 1.5rem;
        }
        
        .filters-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        .filter-actions {
            flex-direction: column;
        }
        
        .btn-primary, .btn-secondary {
            padding: 0.875rem 1.25rem;
            font-size: 0.85rem;
        }
    }
    
    /* Responsive Improvements */
    @media (max-width: 768px) {
        .table {
            font-size: 0.75rem;
        }
        
        .btn {
            padding: 0.375rem 0.5rem;
            font-size: 0.75rem;
        }
        
        .card-body {
            padding: 1rem !important;
        }
        
        .h3 {
            font-size: 1.5rem;
        }
        
        .h6 {
            font-size: 0.875rem;
        }
        
        .avatar {
            width: 32px;
            height: 32px;
        }
        
        .avatar-initial {
            font-size: 0.875rem;
        }
    }
    
    /* Smooth scrolling */
    .table-responsive {
        -webkit-overflow-scrolling: touch;
        border-radius: 12px;
    }
    
    /* Loading animation for empty state */
    .opacity-50 {
        opacity: 0.5;
    }
    
    /* Professional shadows */
    .shadow-sm {
        box-shadow: 0 2px 4px rgba(0,0,0,0.05) !important;
    }
    
    /* Text improvements */
    .text-dark {
        color: #212529 !important;
    }
    
    .fw-semibold {
        font-weight: 600 !important;
    }
    
    .fw-medium {
        font-weight: 500 !important;
    }
    
    /* Modal Styles */
    .modal-content {
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        border: none;
    }
    
    .modal-header {
        border-radius: 16px 16px 0 0;
        padding: 1.5rem;
    }
    
    .modal-icon {
        width: 50px;
        height: 50px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
    }
    
    .modal-body {
        padding: 2rem;
    }
    
    .modal-footer {
        border-radius: 0 0 16px 16px;
        padding: 1.5rem;
    }
    
    /* Info Grid for Delete Modal */
    .info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }
    
    .info-item {
        background: #f8fafc;
        padding: 1rem;
        border-radius: 8px;
        border-left: 3px solid #667eea;
    }
    
    .info-label {
        font-weight: 600;
        color: #64748b;
        font-size: 0.875rem;
        display: block;
        margin-bottom: 0.25rem;
    }
    
    .info-value {
        font-weight: 500;
        color: #1e293b;
        font-size: 0.9rem;
    }
    
    /* Info List for Quick View */
    .info-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }
    
    .info-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem;
        background: #f8fafc;
        border-radius: 8px;
        border-left: 3px solid #667eea;
    }
    
    .info-section {
        background: #f8fafc;
        border-radius: 12px;
        padding: 1.5rem;
        border: 1px solid #e2e8f0;
    }
    
    .content-box {
        background: #ffffff;
        border-radius: 8px;
        padding: 1rem;
        border-left: 4px solid #667eea;
        font-size: 0.9rem;
        line-height: 1.6;
        min-height: 60px;
    }
    
    /* Form Section Styles for Edit Modal */
    .form-section {
        background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
        border-radius: 12px;
        padding: 1.5rem;
        border: 1px solid #e2e8f0;
        margin-bottom: 1.5rem;
    }
    
    .section-header {
        border-bottom: 2px solid #e2e8f0;
        padding-bottom: 0.75rem;
        margin-bottom: 1rem;
    }
    
    .section-header h6 {
        color: #4f46e5;
        font-weight: 600;
        margin: 0;
    }
    
    .form-group {
        margin-bottom: 1rem;
    }
    
    .form-label {
        color: #374151;
        font-weight: 600;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }
    
    .form-control {
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        padding: 0.75rem 1rem;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        background: #ffffff;
    }
    
    .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        background: #ffffff;
    }
    
    textarea.form-control {
        resize: vertical;
        min-height: 80px;
    }
    
    /* Alert Styles */
    .alert {
        border: none;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        backdrop-filter: blur(10px);
        animation: slideInRight 0.3s ease-out;
    }
    
    .alert-success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
    }
    
    .alert-danger {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
    }
    
    .alert .btn-close {
        filter: invert(1);
    }
    
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    /* Required field indicator */
    .text-danger {
        color: #ef4444 !important;
    }
    
    /* Form validation styles */
    .form-control:invalid {
        border-color: #ef4444;
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
    }
    
    .form-control:valid {
        border-color: #10b981;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }
    
    /* Placeholder styles */
    .form-control::placeholder {
        color: #9ca3af;
        font-style: italic;
        font-size: 0.875rem;
    }
    
    /* Help text styles */
    .text-muted {
        color: #6b7280 !important;
        font-size: 0.8rem;
        font-weight: 400;
        margin-top: 0.25rem;
    }
    
    /* Section header improvements */
    .section-header small {
        display: block;
        margin-top: 0.25rem;
        font-size: 0.8rem;
        font-weight: 400;
    }
    
    /* Form section spacing */
    .form-section:last-child {
        margin-bottom: 0;
    }
    
    /* Input group improvements */
    .form-group {
        position: relative;
    }
    
    .form-group small {
        display: block;
        margin-top: 0.25rem;
        line-height: 1.4;
    }
    
    /* Form buttons container */
    .d-flex.justify-content-end.gap-2.mt-4 {
        border-top: 1px solid #e5e7eb;
        padding-top: 1.5rem;
        margin-top: 2rem;
    }
    
    /* Button hover effects for modal actions */
    .detail-btn:hover {
        background: #0ea5e9;
        border-color: #0ea5e9;
        color: white;
        transform: translateY(-1px);
    }
    
    .edit-btn:hover {
        background: #f59e0b;
        border-color: #f59e0b;
        color: white;
        transform: translateY(-1px);
    }
    
    .delete-btn:hover {
        background: #ef4444;
        border-color: #ef4444;
        color: white;
        transform: translateY(-1px);
    }
    
    /* Google Drive icon styles */
    .fab.fa-google-drive {
        font-size: 1.1rem;
        transition: all 0.3s ease;
    }
    
    .btn-outline-warning:hover .fab.fa-google-drive {
        transform: scale(1.1);
        color: white !important;
    }
    
    /* Responsive modal adjustments */
    @media (max-width: 768px) {
        .modal-dialog {
            margin: 1rem;
        }
        
        .info-grid {
            grid-template-columns: 1fr;
        }
        
        .info-row {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Tramitacion list page loaded');
    
    // Verificar que Bootstrap esté disponible
    if (typeof bootstrap === 'undefined') {
        console.error('Bootstrap no está disponible');
        return;
    }
    
    // Función para mostrar alertas
    function showAlert(type, message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; max-width: 400px;';
        alertDiv.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        document.body.appendChild(alertDiv);
        
        setTimeout(() => {
            if (alertDiv && alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
    
    // Función para toggle de filtros
    function toggleFilters() {
        const filtersBody = document.getElementById('filtersBody');
        const iconToggle = document.getElementById('iconToggleFilters');
        const btnToggle = document.getElementById('btnToggleFilters');
        
        if (filtersBody.style.display === 'none') {
            filtersBody.style.display = 'block';
            iconToggle.className = 'fas fa-chevron-up';
            btnToggle.setAttribute('title', 'Ocultar filtros de búsqueda');
        } else {
            filtersBody.style.display = 'none';
            iconToggle.className = 'fas fa-chevron-down';
            btnToggle.setAttribute('title', 'Mostrar filtros de búsqueda');
        }
    }
    
    // Event listener para el botón de toggle de filtros
    const btnToggleFilters = document.getElementById('btnToggleFilters');
    if (btnToggleFilters) {
        btnToggleFilters.addEventListener('click', function(e) {
            e.preventDefault();
            toggleFilters();
        });
    }
    
    // Event listeners para modales
    document.addEventListener('click', function(e) {
        // Edit Modal
        if (e.target.closest('.edit-btn')) {
            console.log('Edit button clicked');
            const btn = e.target.closest('.edit-btn');
            const id = btn.dataset.id;
            const presupuesto = btn.dataset.presupuesto;
            const año = btn.dataset.año;
            const nombre = btn.dataset.nombre;
            const direccion = btn.dataset.direccion;
            const fecha = btn.dataset.fecha;
            const nota = btn.dataset.nota;
            const descripcion = btn.dataset.descripcion;
            const enlace = btn.dataset.enlace;
            
            console.log('Edit data:', { id, presupuesto, año, nombre, direccion, fecha, nota, descripcion, enlace });
            
            // Llenar el formulario de edición
            document.getElementById('editPresupuesto').value = presupuesto;
            document.getElementById('editAño').value = año;
            document.getElementById('editNombre').value = nombre;
            document.getElementById('editDireccion').value = direccion;
            document.getElementById('editFecha').value = fecha;
            document.getElementById('editNota').value = nota;
            document.getElementById('editDescripcion').value = descripcion;
            document.getElementById('editEnlace').value = enlace;
            
            // Actualizar action del formulario
            const editUrl = `/accounts/tramitaciones/${id}/editar/`;
            document.getElementById('editForm').action = editUrl;
            console.log('Edit URL:', editUrl);
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('editModal'));
            modal.show();
        }
        
        // Delete Modal
        if (e.target.closest('.delete-btn')) {
            console.log('Delete button clicked');
            const btn = e.target.closest('.delete-btn');
            const id = btn.dataset.id;
            const presupuesto = btn.dataset.presupuesto;
            const nombre = btn.dataset.nombre;
            const direccion = btn.dataset.direccion;
            const año = btn.dataset.año;
            
            console.log('Delete data:', { id, presupuesto, nombre, direccion, año });
            
            // Llenar el modal con los datos
            document.getElementById('deletePresupuesto').textContent = presupuesto;
            document.getElementById('deleteNombre').textContent = nombre;
            document.getElementById('deleteDireccion').textContent = direccion;
            document.getElementById('deleteAño').textContent = año;
            
            // Actualizar formulario
            const deleteUrl = `/accounts/tramitaciones/eliminar/${id}/`;
            document.getElementById('deleteForm').action = deleteUrl;
            console.log('Delete URL:', deleteUrl);
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
            modal.show();
        }
    });
    
    console.log('Tramitacion modals initialized');
});
    
    // Event listeners para modales - Versión simplificada
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing modals...');
        
        // Detail Modal
        document.querySelectorAll('.detail-btn').forEach(function(btn) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('Detail button clicked');
                
                const id = this.dataset.id;
                const presupuesto = this.dataset.presupuesto;
                const año = this.dataset.año;
                const nombre = this.dataset.nombre;
                const direccion = this.dataset.direccion;
                const fecha = this.dataset.fecha;
                const nota = this.dataset.nota;
                const descripcion = this.dataset.descripcion;
                const enlace = this.dataset.enlace;
                const estado = this.dataset.estado;
                
                // Llenar el modal de detalles
                document.getElementById('detailPresupuesto').innerHTML = `<span class="badge rounded-pill" style="background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);">${presupuesto}</span>`;
                document.getElementById('detailAño').textContent = año;
                document.getElementById('detailNombre').textContent = nombre;
                document.getElementById('detailDireccion').textContent = direccion;
                document.getElementById('detailFecha').textContent = fecha || 'Sin fecha';
                document.getElementById('detailEstado').innerHTML = estado === 'Completado' 
                    ? '<span class="badge rounded-pill" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%);"><i class="fas fa-check-circle me-1"></i>Completado</span>'
                    : '<span class="badge rounded-pill" style="background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);"><i class="fas fa-clock me-1"></i>Pendiente</span>';
                document.getElementById('detailDescripcion').textContent = descripcion || 'Sin descripción';
                document.getElementById('detailNota').textContent = nota || 'Sin notas';
                
                // Llenar documentos
                document.getElementById('detailDocumento').innerHTML = '<span class="text-muted">No disponible</span>';
                
                if (enlace) {
                    document.getElementById('detailEnlace').innerHTML = `<a href="${enlace}" target="_blank" class="btn btn-outline-info btn-sm"><i class="fas fa-external-link-alt me-2"></i>Ver Enlace</a>`;
                } else {
                    document.getElementById('detailEnlace').innerHTML = '<span class="text-muted">No disponible</span>';
                }
                
                // Mostrar modal
                const detailModal = new bootstrap.Modal(document.getElementById('detailModal'));
                detailModal.show();
            });
        });
        
        // Edit Modal
        document.querySelectorAll('.edit-btn').forEach(function(btn) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('Edit button clicked');
                
                const id = this.dataset.id;
                const presupuesto = this.dataset.presupuesto;
                const año = this.dataset.año;
                const nombre = this.dataset.nombre;
                const direccion = this.dataset.direccion;
                const fecha = this.dataset.fecha;
                const nota = this.dataset.nota;
                const descripcion = this.dataset.descripcion;
                const enlace = this.dataset.enlace;
                
                console.log('Edit data:', { id, presupuesto, año, nombre, direccion, fecha, nota, descripcion, enlace });
                
                // Llenar el formulario de edición
                document.getElementById('editPresupuesto').value = presupuesto;
                document.getElementById('editAño').value = año;
                document.getElementById('editNombre').value = nombre;
                document.getElementById('editDireccion').value = direccion;
                document.getElementById('editFecha').value = fecha;
                document.getElementById('editNota').value = nota;
                document.getElementById('editDescripcion').value = descripcion;
                document.getElementById('editEnlace').value = enlace;
                
                // Actualizar action del formulario
                const editUrl = `{% url 'tramitacion-update' 0 %}`.replace('0', id);
                document.getElementById('editForm').action = editUrl;
                console.log('Edit URL:', editUrl);
                
                // Mostrar modal
                const editModal = new bootstrap.Modal(document.getElementById('editModal'));
                editModal.show();
            });
        });
        
        // Delete Modal
        document.querySelectorAll('.delete-btn').forEach(function(btn) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('Delete button clicked');
                
                const id = this.dataset.id;
                const presupuesto = this.dataset.presupuesto;
                const nombre = this.dataset.nombre;
                const direccion = this.dataset.direccion;
                const año = this.dataset.año;
                
                console.log('Delete data:', { id, presupuesto, nombre, direccion, año });
                
                // Llenar el modal con los datos
                document.getElementById('deletePresupuesto').textContent = presupuesto;
                document.getElementById('deleteNombre').textContent = nombre;
                document.getElementById('deleteDireccion').textContent = direccion;
                document.getElementById('deleteAño').textContent = año;
                
                // Actualizar formulario
                const deleteUrl = `{% url 'tramitacion-delete' 0 %}`.replace('0', id);
                document.getElementById('deleteForm').action = deleteUrl;
                console.log('Delete URL:', deleteUrl);
                
                // Mostrar modal
                const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
                deleteModal.show();
            });
        });
    });
    

    
    // Verificar que Bootstrap esté disponible
    if (typeof bootstrap === 'undefined') {
        console.error('Bootstrap no está disponible');
        alert('Error: Bootstrap no está cargado correctamente');
    } else {
        console.log('Bootstrap está disponible');
    }

    // Botón de prueba para verificar modales
    document.getElementById('testModalBtn')?.addEventListener('click', function() {
        console.log('Test modal button clicked');
        try {
            const testModal = new bootstrap.Modal(document.getElementById('detailModal'));
            testModal.show();
            console.log('Test modal opened successfully');
        } catch (error) {
            console.error('Error opening test modal:', error);
            alert('Error al abrir modal de prueba: ' + error.message);
        }
    });

    // Toggle de filtros
    document.getElementById('btnToggleFilters')?.addEventListener('click', function() {
        const filtersBody = document.getElementById('filtersBody');
        const icon = document.getElementById('iconToggleFilters');
        
        if (filtersBody.style.display === 'none') {
            filtersBody.style.display = 'block';
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-up');
        } else {
            filtersBody.style.display = 'none';
            icon.classList.remove('fa-chevron-up');
            icon.classList.add('fa-chevron-down');
        }
    });

    // Limpiar filtros avanzados
    document.getElementById('clearFiltersBtn')?.addEventListener('click', function() {
        const form = document.getElementById('advancedFiltersForm');
        form.reset();
        form.submit();
    });
    
    // Botón para abrir filtros avanzados
    document.addEventListener('click', function(e) {
        if (e.target.matches('[data-bs-target="#advancedFiltersModal"]')) {
            const modal = new bootstrap.Modal(document.getElementById('advancedFiltersModal'));
            modal.show();
        }
    });
    
    // Manejo del formulario de creación
    const createForm = document.getElementById('createForm');
    if (createForm) {
        createForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const submitBtn = document.getElementById('createSubmitBtn');
            
            if (!submitBtn) {
                console.error('Botón de envío no encontrado');
                return;
            }
            
            const originalText = submitBtn.innerHTML;
            
            // Cambiar estado del botón
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creando...';
            
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                }
            })
            .then(response => {
                console.log('Create response status:', response.status);
                console.log('Create response headers:', response.headers);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    return response.json();
                } else {
                    // Si no es JSON, obtener el texto para debug
                    return response.text().then(text => {
                        console.error('Create response is not JSON:', text);
                        throw new Error('La respuesta no es JSON válido');
                    });
                }
            })
            .then(data => {
                console.log('Create response data:', data);
                if (data.success) {
                    // Mostrar mensaje de éxito
                    showAlert('success', '¡Tramitación creada exitosamente!');
                    
                    // Cerrar modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('createModal'));
                    if (modal) {
                        modal.hide();
                    }
                    
                    // Update the page content without reload
                    setTimeout(() => {
                        updatePageContent();
                    }, 1000);
                } else {
                    // Mostrar errores
                    showAlert('danger', data.message || 'Error al crear la tramitación');
                }
            })
            .catch(error => {
                console.error('Create error:', error);
                showAlert('danger', `Error de conexión: ${error.message}`);
            })
            .finally(() => {
                // Restaurar botón
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            });
        });
    }
    
    // Función para mostrar alertas
    function showAlert(type, message) {
        try {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; max-width: 400px;';
            alertDiv.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            // Remover alertas existentes
            const existingAlerts = document.querySelectorAll('.alert.position-fixed');
            existingAlerts.forEach(alert => alert.remove());
            
            document.body.appendChild(alertDiv);
            
            // Auto-remover después de 5 segundos
            setTimeout(() => {
                if (alertDiv && alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        } catch (error) {
            console.error('Error al mostrar alerta:', error);
            // Fallback: usar alert nativo
            alert(message);
        }
    }
    
    // Limpiar formulario cuando se cierre el modal
    const createModal = document.getElementById('createModal');
    if (createModal) {
        createModal.addEventListener('hidden.bs.modal', function() {
            const form = document.getElementById('createForm');
            if (form) {
                form.reset();
            }
        });
    }
    
    // Manejo del formulario de edición
    const editForm = document.getElementById('editForm');
    if (editForm) {
        editForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const submitBtn = document.querySelector('#editForm button[type="submit"]');
            
            if (!submitBtn) {
                console.error('Botón de envío de edición no encontrado');
                return;
            }
            
            const originalText = submitBtn.innerHTML;
            
            // Cambiar estado del botón
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Guardando...';
            
            console.log('Edit form action:', this.action);
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                }
            })
            .then(response => {
                console.log('Edit response status:', response.status);
                console.log('Edit response headers:', response.headers);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    return response.json();
                } else {
                    // Si no es JSON, obtener el texto para debug
                    return response.text().then(text => {
                        console.error('Edit response is not JSON:', text);
                        throw new Error('La respuesta no es JSON válido');
                    });
                }
            })
            .then(data => {
                console.log('Edit response data:', data);
                if (data.success) {
                    // Mostrar mensaje de éxito
                    showAlert('success', '¡Tramitación actualizada exitosamente!');
                    
                    // Cerrar modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
                    if (modal) {
                        modal.hide();
                    }
                    
                    // Update the page content without reload
                    setTimeout(() => {
                        updatePageContent();
                    }, 1000);
                } else {
                    // Mostrar errores
                    showAlert('danger', data.message || 'Error al actualizar la tramitación');
                }
            })
            .catch(error => {
                console.error('Edit error:', error);
                showAlert('danger', `Error de conexión: ${error.message}`);
            })
            .finally(() => {
                // Restaurar botón
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            });
        });
    }
    
    // Manejo del formulario de eliminación
    const deleteForm = document.getElementById('deleteForm');
    if (deleteForm) {
        deleteForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const submitBtn = document.querySelector('#deleteForm button[type="submit"]');
            
            if (!submitBtn) {
                console.error('Botón de envío de eliminación no encontrado');
                return;
            }
            
            const originalText = submitBtn.innerHTML;
            
            // Cambiar estado del botón
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Eliminando...';
            
            console.log('Delete form action:', this.action);
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                }
            })
            .then(response => {
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    return response.json();
                } else {
                    // Si no es JSON, obtener el texto para debug
                    return response.text().then(text => {
                        console.error('Response is not JSON:', text);
                        throw new Error('La respuesta no es JSON válido');
                    });
                }
            })
            .then(data => {
                console.log('Response data:', data);
                if (data.success) {
                    // Mostrar mensaje de éxito
                    showAlert('success', '¡Tramitación eliminada exitosamente!');
                    
                    // Cerrar modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
                    if (modal) {
                        modal.hide();
                    }
                    
                    // Update the page content without reload
                    setTimeout(() => {
                        updatePageContent();
                    }, 1000);
                } else {
                    // Mostrar errores
                    showAlert('danger', data.message || 'Error al eliminar la tramitación');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('danger', `Error de conexión: ${error.message}`);
            })
            .finally(() => {
                // Restaurar botón
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            });
        });
    }
});
</script>

<script src="{% static 'js/tramitacion_modals.js' %}"></script>
{% endblock %}