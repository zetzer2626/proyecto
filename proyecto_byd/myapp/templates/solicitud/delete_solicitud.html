{% extends 'base.html' %}

{% block title %}Eliminar Solicitud - {{ object.nombre|default:"Sin nombre" }}{% endblock %}

{% block page_title %}Eliminar Solicitud{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="page-title text-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>Eliminar Solicitud
            </h1>
            <p class="page-subtitle">
                Esta acción no se puede deshacer. Confirme que desea eliminar esta solicitud.
            </p>
        </div>
        <div>
            <a href="{% url 'solicitud-detail' object.pk %}" class="btn btn-outline-info me-2">
                <i class="fas fa-eye me-2"></i>Ver Detalles
            </a>
            <a href="{% url 'solicitud-list' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Volver a Lista
            </a>
        </div>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-lg-8">
        <!-- Advertencia Principal -->
        <div class="card border-danger mb-4">
            <div class="card-header bg-danger text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>⚠️ Confirmación de Eliminación
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-danger" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-exclamation-circle fs-2 me-3"></i>
                        <div>
                            <h6 class="alert-heading mb-1">¡Atención! Esta acción es irreversible</h6>
                            <p class="mb-0">Una vez eliminada, no podrá recuperar esta solicitud ni sus documentos adjuntos.</p>
                        </div>
                    </div>
                </div>
                
                <div class="deletion-summary bg-light rounded-3 p-4">
                    <h6 class="mb-3 text-danger">
                        <i class="fas fa-trash me-2"></i>Se eliminará la siguiente solicitud:
                    </h6>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="info-item mb-3">
                                <label class="info-label">
                                    <i class="fas fa-user me-1"></i>Solicitante
                                </label>
                                <p class="info-value fw-semibold">{{ object.solicitante|default:"No especificado" }}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-item mb-3">
                                <label class="info-label">
                                    <i class="fas fa-file-alt me-1"></i>Documento
                                </label>
                                <p class="info-value fw-semibold">{{ object.nombre_documento|default:"No especificado" }}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="info-item mb-3">
                                <label class="info-label">
                                    <i class="fas fa-id-badge me-1"></i>Cliente
                                </label>
                                <p class="info-value fw-semibold">{{ object.nombre|default:"No especificado" }}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-item mb-3">
                                <label class="info-label">
                                    <i class="fas fa-calendar me-1"></i>Estado
                                </label>
                                <p class="info-value">
                                    <span class="badge {% if object.fecha_solicitud and object.fecha_recepcion %}bg-success{% elif object.fecha_solicitud %}bg-warning{% else %}bg-secondary{% endif %}">
                                        {% if object.fecha_solicitud and object.fecha_recepcion %}
                                            Completada
                                        {% elif object.fecha_solicitud %}
                                            En Proceso
                                        {% else %}
                                            Pendiente
                                        {% endif %}
                                    </span>
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    {% if object.direccion %}
                    <div class="info-item mb-3">
                        <label class="info-label">
                            <i class="fas fa-map-marker-alt me-1"></i>Dirección
                        </label>
                        <p class="info-value">{{ object.direccion }}</p>
                    </div>
                    {% endif %}
                    
                    {% if object.descripcion %}
                    <div class="info-item mb-3">
                        <label class="info-label">
                            <i class="fas fa-align-left me-1"></i>Descripción
                        </label>
                        <div class="info-value">
                            <div class="description-preview bg-white p-3 rounded border">
                                {{ object.descripcion|truncatewords:30|linebreaks }}
                                {% if object.descripcion|length > 200 %}
                                    <small class="text-muted">... (descripción completa)</small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Elementos que se perderán -->
                <div class="mt-4">
                    <h6 class="text-warning mb-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>Elementos que se eliminarán permanentemente:
                    </h6>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <ul class="list-unstyled">
                                <li class="mb-2">
                                    <i class="fas fa-check text-danger me-2"></i>
                                    <strong>Información de la solicitud</strong>
                                    <br><small class="text-muted">Todos los datos del formulario</small>
                                </li>
                                {% if object.fecha_solicitud %}
                                <li class="mb-2">
                                    <i class="fas fa-check text-danger me-2"></i>
                                    <strong>Fechas registradas</strong>
                                    <br><small class="text-muted">Solicitud: {{ object.fecha_solicitud }}</small>
                                    {% if object.fecha_recepcion %}
                                        <br><small class="text-muted">Recepción: {{ object.fecha_recepcion }}</small>
                                    {% endif %}
                                </li>
                                {% endif %}
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <ul class="list-unstyled">
                                {% if object.documento_solicitud %}
                                <li class="mb-2">
                                    <i class="fas fa-check text-danger me-2"></i>
                                    <strong>Documento adjunto</strong>
                                    <br><small class="text-muted">{{ object.documento_solicitud.name }}</small>
                                </li>
                                {% endif %}
                                {% if object.link_solicitud %}
                                <li class="mb-2">
                                    <i class="fas fa-check text-danger me-2"></i>
                                    <strong>Enlace asociado</strong>
                                    <br><small class="text-muted">{{ object.link_solicitud|truncatechars:40 }}</small>
                                </li>
                                {% endif %}
                                {% if not object.documento_solicitud and not object.link_solicitud %}
                                <li class="mb-2">
                                    <i class="fas fa-info text-muted me-2"></i>
                                    <small class="text-muted">Sin documentos o enlaces adjuntos</small>
                                </li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Formulario de Confirmación -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-shield-alt me-2"></i>Confirmación Final
                </h5>
            </div>
            <div class="card-body">
                <form method="post" id="deleteForm">
                    {% csrf_token %}
                    
                    <div class="confirmation-section mb-4">
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="confirmUnderstanding" required>
                            <label class="form-check-label" for="confirmUnderstanding">
                                <strong>Entiendo que esta acción es irreversible</strong>
                                <br><small class="text-muted">He leído y comprendo que no podré recuperar esta información</small>
                            </label>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="confirmDataLoss" required>
                            <label class="form-check-label" for="confirmDataLoss">
                                <strong>Confirmo la pérdida de todos los datos asociados</strong>
                                <br><small class="text-muted">Incluyendo documentos, fechas y enlaces relacionados</small>
                            </label>
                        </div>
                        
                        <div class="verification-input mb-4">
                            <label for="confirmationText" class="form-label">
                                <strong>Para confirmar, escriba "ELIMINAR" en el siguiente campo:</strong>
                            </label>
                            <input type="text" class="form-control" id="confirmationText" 
                                   placeholder="Escriba ELIMINAR para confirmar" 
                                   autocomplete="off" required>
                            <div class="invalid-feedback">
                                Debe escribir exactamente "ELIMINAR" para continuar
                            </div>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="d-flex gap-2 flex-wrap">
                                    <button type="submit" class="btn btn-danger" id="deleteBtn" disabled>
                                        <i class="fas fa-trash me-2"></i>Eliminar Solicitud Definitivamente
                                    </button>
                                    <a href="{% url 'solicitud-detail' object.pk %}" class="btn btn-outline-info">
                                        <i class="fas fa-eye me-2"></i>Ver Detalles
                                    </a>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <a href="{% url 'solicitud-list' %}" class="btn btn-secondary">
                                    <i class="fas fa-times me-2"></i>Cancelar
                                </a>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Alternativas Sugeridas -->
        <div class="card mt-4 border-info">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-lightbulb me-2"></i>💡 ¿Considera estas alternativas?
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="alternative-option p-3 bg-light rounded mb-3">
                            <h6 class="text-primary">
                                <i class="fas fa-edit me-2"></i>Editar Solicitud
                            </h6>
                            <p class="mb-2">Modifique la información en lugar de eliminarla</p>
                            <a href="{% url 'solicitud-update' object.pk %}" class="btn btn-sm btn-outline-primary">
                                Editar en su lugar
                            </a>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="alternative-option p-3 bg-light rounded mb-3">
                            <h6 class="text-success">
                                <i class="fas fa-download me-2"></i>Respaldar Información
                            </h6>
                            <p class="mb-2">Guarde una copia antes de eliminar</p>
                            {% if object.documento_solicitud %}
                            <a href="{{ object.documento_solicitud.url }}" download class="btn btn-sm btn-outline-success">
                                Descargar Documento
                            </a>
                            {% else %}
                            <small class="text-muted">Sin documentos para respaldar</small>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="text-center mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Estas alternativas le permitirán conservar la información importante
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<style>
    .info-label {
        font-weight: 600;
        color: var(--primary-color);
        font-size: 0.9rem;
        margin-bottom: 0.25rem;
        display: block;
    }
    
    .info-value {
        margin-bottom: 0;
        color: var(--text-dark);
        font-size: 1rem;
    }
    
    .deletion-summary {
        border-left: 4px solid var(--danger-color);
    }
    
    .description-preview {
        border-left: 3px solid var(--warning-color);
        max-height: 100px;
        overflow-y: auto;
    }
    
    .alternative-option {
        border: 2px solid transparent;
        transition: all 0.3s ease;
    }
    
    .alternative-option:hover {
        border-color: var(--accent-color);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .verification-input input {
        border: 2px solid var(--danger-color);
        font-weight: bold;
        text-transform: uppercase;
    }
    
    .verification-input input:focus {
        border-color: var(--danger-color);
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
    }
    
    .verification-input input.is-valid {
        border-color: var(--success-color);
    }
    
    .btn-danger:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .form-check-input:checked {
        background-color: var(--danger-color);
        border-color: var(--danger-color);
    }
    
    .card.border-danger {
        border-width: 2px !important;
    }
    
    .card.border-info {
        border-width: 2px !important;
    }
    
    /* Animation for warning elements */
    .alert-danger {
        animation: pulseWarning 2s infinite;
    }
    
    @keyframes pulseWarning {
        0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4); }
        70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
        100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
    }
    
    /* Confirmation progress indicator */
    .confirmation-progress {
        height: 4px;
        background: var(--medium-gray);
        border-radius: 2px;
        overflow: hidden;
        margin-bottom: 1rem;
    }
    
    .confirmation-progress-bar {
        height: 100%;
        background: linear-gradient(90deg, var(--danger-color), var(--warning-color));
        width: 0%;
        transition: width 0.3s ease;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('deleteForm');
        const deleteBtn = document.getElementById('deleteBtn');
        const confirmUnderstanding = document.getElementById('confirmUnderstanding');
        const confirmDataLoss = document.getElementById('confirmDataLoss');
        const confirmationText = document.getElementById('confirmationText');
        
        // Create progress indicator
        const progressContainer = document.createElement('div');
        progressContainer.className = 'confirmation-progress mb-3';
        progressContainer.innerHTML = '<div class="confirmation-progress-bar"></div>';
        document.querySelector('.confirmation-section').prepend(progressContainer);
        
        const progressBar = document.querySelector('.confirmation-progress-bar');
        
        function updateFormState() {
            let progress = 0;
            let canSubmit = true;
            
            // Check understanding checkbox
            if (confirmUnderstanding.checked) {
                progress += 33;
            } else {
                canSubmit = false;
            }
            
            // Check data loss confirmation
            if (confirmDataLoss.checked) {
                progress += 33;
            } else {
                canSubmit = false;
            }
            
            // Check confirmation text
            if (confirmationText.value.toUpperCase() === 'ELIMINAR') {
                progress += 34;
                confirmationText.classList.remove('is-invalid');
                confirmationText.classList.add('is-valid');
            } else {
                canSubmit = false;
                confirmationText.classList.remove('is-valid');
                if (confirmationText.value.length > 0) {
                    confirmationText.classList.add('is-invalid');
                }
            }
            
            // Update progress bar
            progressBar.style.width = progress + '%';
            
            // Enable/disable submit button
            deleteBtn.disabled = !canSubmit;
            
            if (canSubmit) {
                deleteBtn.innerHTML = '<i class="fas fa-trash me-2"></i>Confirmar Eliminación';
                deleteBtn.classList.remove('btn-danger');
                deleteBtn.classList.add('btn-danger');
            } else {
                deleteBtn.innerHTML = '<i class="fas fa-lock me-2"></i>Complete la confirmación';
            }
        }
        
        // Event listeners
        confirmUnderstanding.addEventListener('change', updateFormState);
        confirmDataLoss.addEventListener('change', updateFormState);
        confirmationText.addEventListener('input', updateFormState);
        
        // Form submission with extra confirmation
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Final confirmation dialog
            const finalConfirm = confirm(
                '⚠️ ÚLTIMA CONFIRMACIÓN ⚠️\n\n' +
                'Esta es su última oportunidad para cancelar.\n' +
                'La solicitud será eliminada permanentemente.\n\n' +
                '¿Está completamente seguro de continuar?'
            );
            
            if (finalConfirm) {
                // Show loading state
                deleteBtn.innerHTML = '<div class="spinner-border spinner-border-sm me-2" role="status"></div>Eliminando...';
                deleteBtn.disabled = true;
                
                // Submit form after a brief delay to show loading state
                setTimeout(() => {
                    form.submit();
                }, 1000);
            }
        });
        
        // Prevent accidental navigation
        window.addEventListener('beforeunload', function(e) {
            if (confirmUnderstanding.checked || confirmDataLoss.checked || confirmationText.value.length > 0) {
                e.preventDefault();
                e.returnValue = '';
                return 'Tiene confirmaciones parcialmente completadas. ¿Está seguro de salir?';
            }
        });
        
        // Auto-focus on first checkbox
        setTimeout(() => {
            confirmUnderstanding.focus();
        }, 500);
        
        // Add warning sound effect (optional)
        function playWarningSound() {
            // You can add a subtle warning sound here
            console.log('Warning: Deletion process initiated');
        }
        
        // Initialize form state
        updateFormState();
        
        // Add hover effects to alternative options
        document.querySelectorAll('.alternative-option').forEach(function(option) {
            option.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-3px)';
            });
            
            option.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
            });
        });
        
        // Animate entry of warning elements
        const alertElement = document.querySelector('.alert-danger');
        if (alertElement) {
            alertElement.style.transform = 'scale(0.95)';
            alertElement.style.opacity = '0';
            
            setTimeout(() => {
                alertElement.style.transition = 'all 0.5s ease';
                alertElement.style.transform = 'scale(1)';
                alertElement.style.opacity = '1';
            }, 200);
        }
        
        console.log('Sistema de eliminación de solicitudes cargado correctamente');
    });
</script>
{% endblock %}
